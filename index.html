<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube è™›æ“¬å‰ªè¼¯å·¥å…·</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¨­å®š Tailwind é…ç½® -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* éŸ¿æ‡‰å¼å½±ç‰‡å®¹å™¨æ¨£å¼ (16:9 æ¯”ä¾‹) */
        .video-wrapper {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
            overflow: hidden;
            border-radius: 0.5rem; /* rounded-xl */
        }
        /* ç¢ºä¿å…§å±¤æ’­æ”¾å™¨å¡«æ»¿å®¹å™¨ */
        #player, #share-player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        /* ä¿®æ­£æ‰‹æ©Ÿå°ºå¯¸æº¢å‡ºå•é¡Œï¼šå¼·åˆ¶éš±è—æ°´å¹³æ»¾å‹•æ¢ */
        body {
            overflow-x: hidden;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans p-4 sm:p-8">

    <div id="app-container" class="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-2xl space-y-8">
        <h1 class="text-3xl font-bold text-gray-800 border-b pb-3 mb-6">YouTube ç²¾è¯ç‰‡æ®µæ’­æ”¾æ¸…å–®</h1>

        <!-- è¨Šæ¯/è­¦å‘Šå€ -->
        <div id="message-box" class="hidden p-4 rounded-lg text-sm transition-all duration-300"></div>

        <!-- ç·¨è¼¯ä»‹é¢ (é è¨­é¡¯ç¤º) -->
        <div id="editor-view" class="space-y-6">
            <!-- YouTube ç¶²å€è¼¸å…¥å€ -->
            <div class="space-y-4 p-4 border border-blue-200 bg-blue-50 rounded-lg">
                <label for="youtube-url" class="block text-lg font-semibold text-gray-700">æ­¥é©Ÿ 1: è¼¸å…¥ YouTube å½±ç‰‡ç¶²å€</label>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="url" id="youtube-url" placeholder="ä¾‹å¦‚ï¼šhttps://www.youtube.com/watch?v=dQw4w9WgXcQ"
                           class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                           value="">
                    <button id="load-video-btn" onclick="loadVideoFromInput()"
                            class="w-full sm:w-auto px-6 py-3 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700 transition duration-150">
                        è¼‰å…¥å½±ç‰‡
                    </button>
                </div>
            </div>

            <!-- ç·¨è¼¯å€ (è¼‰å…¥å½±ç‰‡å¾Œé¡¯ç¤º) -->
            <div id="edit-area" class="hidden space-y-6">
                <h2 class="text-2xl font-semibold text-gray-800">æ­¥é©Ÿ 2: å‰ªè¼¯ç‰‡æ®µç·¨è¼¯</h2>

                <div id="player-status" class="text-center text-gray-600 font-medium mb-4">
                    ç•¶å‰æ’­æ”¾æ™‚é–“: <span id="current-time" class="text-blue-600">00:00</span>
                </div>

                <!-- YouTube æ’­æ”¾å™¨ (å·²åŠ å…¥ .video-wrapper) -->
                <div id="player-container" class="video-wrapper">
                    <div id="player"></div>
                </div>

                <!-- ç‰‡æ®µåˆ—è¡¨ -->
                <div id="segments-list" class="space-y-4 p-4 border border-gray-200 rounded-lg bg-white shadow-inner">
                    <!-- Segment input will be injected here -->
                </div>

                <!-- æ–°å¢ç‰‡æ®µæŒ‰éˆ• -->
                <button onclick="addSegment()"
                        class="w-full px-4 py-3 border border-blue-500 text-blue-600 font-medium rounded-lg hover:bg-blue-50 transition duration-150 flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    <span>æ–°å¢æ™‚é–“é»è¼¸å…¥å€</span>
                </button>

                <!-- é è¦½å®Œæ•´å‰ªæ¥å½±ç‰‡æŒ‰éˆ• -->
                <div class="pt-4 border-t mt-6">
                    <button id="play-full-spliced-btn" onclick="playFullSplicedVideo()" disabled
                            class="w-full px-6 py-3 bg-green-500 text-white font-bold rounded-lg shadow-lg hover:bg-green-600 transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                        é è¦½å®Œæ•´å‰ªæ¥å½±ç‰‡ (0 ç‰‡æ®µ)
                    </button>
                </div>
            </div>
        </div>

        <!-- åˆ†äº«ä»‹é¢ (ç¶²å€æœ‰åƒæ•¸æ™‚é¡¯ç¤º) -->
        <div id="share-view" class="hidden space-y-6">
            <h2 class="text-2xl font-semibold text-gray-800 text-center">åˆ†äº«çš„ç²¾è¯ç‰‡æ®µæ’­æ”¾æ¸…å–®</h2>
            <p id="share-info" class="text-center text-gray-600"></p>

            <!-- YouTube æ’­æ”¾å™¨ for share view (å·²åŠ å…¥ .video-wrapper) -->
            <div id="share-player-container" class="w-full max-w-2xl mx-auto video-wrapper">
                <div id="share-player"></div>
            </div>

            <div class="text-center pt-4">
                <button onclick="window.location.href = window.location.origin + window.location.pathname"
                        class="px-6 py-3 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-150">
                    è¿”å›ç·¨è¼¯æ¨¡å¼
                </button>
            </div>
        </div>

        <!-- åˆ†äº«é€£çµå€ (ç·¨è¼¯æ¨¡å¼ä¸‹é¡¯ç¤º) -->
        <div id="share-link-area" class="hidden pt-6 border-t mt-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-3">åˆ†äº«é€£çµ</h3>
            <div class="flex flex-col sm:flex-row gap-2">
                <input type="text" id="share-link" readonly
                       class="flex-grow p-3 border border-gray-300 bg-gray-100 rounded-lg text-sm overflow-hidden whitespace-nowrap text-ellipsis">
                <button onclick="copyShareLink()"
                        class="w-full sm:w-auto px-6 py-3 bg-indigo-600 text-white font-medium rounded-lg shadow-md hover:bg-indigo-700 transition duration-150">
                    è¤‡è£½é€£çµ
                </button>
            </div>
        </div>
    </div>

    <!-- è¼‰å…¥ YouTube Player API -->
    <script>
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    </script>

    <script>
        // --- å…¨åŸŸè®Šæ•¸ ---
        let player; // for editor view
        let sharePlayer; // for share view
        let videoId = '';
        let segments = []; // [{ start: number, end: number, startInput: string, endInput: string }, ...]
        let isPlayingSequence = false;
        let currentSegmentIndex = 0;
        let intervalId = null; // ç·¨è¼¯æ¨¡å¼çš„è¨ˆæ™‚å™¨
        let shareIntervalId = null; // åˆ†äº«æ¨¡å¼çš„è¨ˆæ™‚å™¨
        let isShareMode = false;

        // --- è¼”åŠ©å‡½æ•¸ï¼šæ™‚é–“æ ¼å¼è½‰æ› (MM:SS <-> Seconds) ---

        /** å°‡ç§’æ•¸è½‰æ›ç‚º MM:SS æ ¼å¼ */
        function secondsToTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = Math.floor(totalSeconds % 60);
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        /** å°‡ MM:SS æ ¼å¼å­—ä¸²è½‰æ›ç‚ºç§’æ•¸ (æ”¯æ´ SS æˆ– MM:SS) */
        function timeToSeconds(timeStr) {
            if (!timeStr) return 0;
            const parts = timeStr.split(':').map(p => parseInt(p.trim()) || 0);
            if (parts.length === 1) {
                return parts[0]; // åªæä¾›ç§’æ•¸
            } else if (parts.length === 2) {
                return parts[0] * 60 + parts[1]; // MM:SS
            }
            return 0;
        }

        /** é¡¯ç¤ºè¨Šæ¯æ¡† */
        function displayMessage(message, type = 'info') {
            const box = document.getElementById('message-box');
            box.innerText = message;
            box.className = 'p-4 rounded-lg text-sm transition-all duration-300'; // Reset classes
            box.classList.remove('hidden');

            switch (type) {
                case 'success':
                    box.classList.add('bg-green-100', 'text-green-800');
                    break;
                case 'error':
                    box.classList.add('bg-red-100', 'text-red-800');
                    break;
                case 'warning':
                    box.classList.add('bg-yellow-100', 'text-yellow-800');
                    break;
                case 'info':
                default:
                    box.classList.add('bg-blue-100', 'text-blue-800');
                    break;
            }
            // è®“è¨Šæ¯æŒçºŒé¡¯ç¤º 5 ç§’
            setTimeout(() => {
                 box.classList.add('hidden');
            }, 5000);
        }

        // --- æ­¥é©Ÿ 1: è¼‰å…¥å½±ç‰‡ ---

        /** å¾ç¶²å€è¼¸å…¥æ¡†è¼‰å…¥å½±ç‰‡ */
        function loadVideoFromInput() {
            const urlInput = document.getElementById('youtube-url').value;
            const id = extractVideoId(urlInput);

            if (!id) {
                displayMessage('è«‹è¼¸å…¥æœ‰æ•ˆçš„ YouTube å½±ç‰‡ç¶²å€æˆ– IDã€‚', 'error');
                return;
            }

            videoId = id;
            document.getElementById('edit-area').classList.remove('hidden');
            document.getElementById('load-video-btn').disabled = true;

            // å¦‚æœæ’­æ”¾å™¨å°šæœªåˆå§‹åŒ–ï¼Œå‰‡åˆå§‹åŒ–
            if (!player) {
                initYouTubePlayer('player', videoId, true);
            } else {
                // å¦‚æœå·²ç¶“å­˜åœ¨ï¼Œå‰‡ç›´æ¥è¼‰å…¥æ–°å½±ç‰‡
                player.loadVideoById(videoId);
            }

            // ç¢ºä¿è‡³å°‘æœ‰ä¸€å€‹ç‰‡æ®µè¼¸å…¥å€
            if (segments.length === 0) {
                addSegment();
            }

            // æ›´æ–°åˆ†äº«é€£çµ
            updateShareLink();
        }

        /** å¾ URL æå– YouTube å½±ç‰‡ ID */
        function extractVideoId(url) {
            if (!url) return null;
            let id = null;
            url = url.replace(/(>|<)/gi, '').split(/(\/embed\/|v=|\/v\/|\/youtu\.be\/|\/shorts\/|\/live\/)/);
            if (url[2]) {
                id = url[2].split(/[^0-9a-z_-]/i);
                id = id[0];
            } else {
                id = url.join('').match(/[a-zA-Z0-9_-]{11}/);
                id = id ? id[0] : null;
            }
            return id;
        }


        // --- YouTube API æ’­æ”¾å™¨æ§åˆ¶ ---

        /** åˆå§‹åŒ– YouTube Player */
        function initYouTubePlayer(elementId, id, isEditor) {
            return new YT.Player(elementId, {
                videoId: id,
                playerVars: {
                    'controls': 1,
                    'modestbranding': 1,
                    'rel': 0, // é—œé–‰ç›¸é—œå½±ç‰‡
                    'showinfo': 0, 
                    'iv_load_policy': 3 // é—œéµï¼šä¸è¼‰å…¥å½±ç‰‡è¨»è§£/è³‡è¨Šå¡ï¼Œæ¸›å°‘è·³è½‰æ™‚çš„é–ƒçˆ
                },
                events: {
                    'onReady': (event) => onPlayerReady(event, isEditor),
                    'onStateChange': (event) => onPlayerStateChange(event, isEditor)
                }
            });
        }

        /** æ’­æ”¾å™¨æº–å‚™å¥½æ™‚ */
        function onPlayerReady(event, isEditor) {
            if (isEditor) {
                // ç·¨è¼¯æ¨¡å¼çš„æ’­æ”¾å™¨
                player = event.target;
                document.getElementById('load-video-btn').disabled = false;
                document.getElementById('youtube-url').disabled = true;

                // é¡¯ç¤ºè¼‰å…¥æˆåŠŸè¨Šæ¯
                displayMessage(`å½±ç‰‡å·²è¼‰å…¥ (ID: ${videoId})ã€‚è«‹åœ¨ä¸‹æ–¹ç·¨è¼¯å‰ªè¼¯é»ã€‚`, 'success');

            } else {
                // åˆ†äº«æ¨¡å¼çš„æ’­æ”¾å™¨
                sharePlayer = event.target;
                // åˆ†äº«æ¨¡å¼è¼‰å…¥å¾Œç«‹å³é–‹å§‹æ’­æ”¾åºåˆ—
                if (isShareMode && segments.length > 0) {
                    playFullSplicedVideo(true); // true è¡¨ç¤ºä½¿ç”¨ sharePlayer
                }
            }
        }

        /** æ’­æ”¾ç‹€æ…‹æ”¹è®Šæ™‚ */
        function onPlayerStateChange(event, isEditor) {
            const activePlayer = isEditor ? player : sharePlayer;

            if (event.data === YT.PlayerState.PLAYING) {
                // è™•ç†ç·¨è¼¯æ¨¡å¼ (éœ€è¦æ›´æ–°æ™‚é–“é¡¯ç¤º)
                if (isEditor) {
                    if (!intervalId) {
                        const currentTimeDisplay = document.getElementById('current-time');
                        intervalId = setInterval(() => {
                            currentTimeDisplay.innerText = secondsToTime(activePlayer.getCurrentTime());
                            if (isPlayingSequence) {
                                checkSegmentEnd(activePlayer);
                            }
                        }, 100);
                    }
                // è™•ç†åˆ†äº«æ¨¡å¼ (ä¸éœ€è¦æ›´æ–°æ™‚é–“é¡¯ç¤ºï¼Œä½†éœ€è¦æª¢æŸ¥ç‰‡æ®µçµæŸ)
                } else {
                     // ç‚º sharePlayer è¨­ç½®å°ˆå±¬çš„è¨ˆæ™‚å™¨ä¾†æª¢æŸ¥ç‰‡æ®µçµæŸ
                     if (!shareIntervalId) {
                        shareIntervalId = setInterval(() => {
                            if (isPlayingSequence) {
                                checkSegmentEnd(activePlayer);
                            }
                        }, 100);
                    }
                }
            } else {
                // éæ’­æ”¾ç‹€æ…‹æ™‚æ¸…é™¤è¨ˆæ™‚å™¨
                if (isEditor) {
                    if (intervalId) {
                        clearInterval(intervalId);
                        intervalId = null;
                    }
                } else {
                    if (shareIntervalId) {
                        clearInterval(shareIntervalId);
                        shareIntervalId = null;
                    }
                }
                
                // ç„¡è«–å“ªç¨®æ¨¡å¼ï¼Œå½±ç‰‡çµæŸæ™‚éƒ½åœæ­¢åºåˆ—æ’­æ”¾
                if (event.data === YT.PlayerState.ENDED) {
                    if (isPlayingSequence) {
                        stopSequencePlayback(activePlayer);
                    }
                }
            }
        }

        /** æª¢æŸ¥ç•¶å‰ç‰‡æ®µæ˜¯å¦çµæŸï¼Œä¸¦è·³è½‰æˆ–åœæ­¢ */
        function checkSegmentEnd(activePlayer) {
            if (!isPlayingSequence || segments.length === 0) return;

            const segment = segments[currentSegmentIndex];
            const currentTime = activePlayer.getCurrentTime();

            // å¦‚æœç•¶å‰æ™‚é–“å¤§æ–¼ç‰‡æ®µçš„çµæŸæ™‚é–“ï¼Œå‰‡åˆ‡æ›åˆ°ä¸‹ä¸€å€‹ç‰‡æ®µ
            if (currentTime > segment.end) {
                activePlayer.pauseVideo();
                currentSegmentIndex++;

                if (currentSegmentIndex < segments.length) {
                    // æ’­æ”¾ä¸‹ä¸€å€‹ç‰‡æ®µ
                    const nextSegment = segments[currentSegmentIndex];
                    activePlayer.seekTo(nextSegment.start, true);
                    activePlayer.playVideo();
                } else {
                    // åºåˆ—æ’­æ”¾å®Œæˆ
                    stopSequencePlayback(activePlayer);
                    displayMessage('ğŸ‰ ç²¾è¯ç‰‡æ®µæ’­æ”¾å®Œç•¢ï¼', 'success');
                }
            }
        }

        /** åœæ­¢åºåˆ—æ’­æ”¾ */
        function stopSequencePlayback(activePlayer) {
            isPlayingSequence = false;
            currentSegmentIndex = 0;

            // çµ±ä¸€æ¸…é™¤æ‰€æœ‰å¯èƒ½çš„è¨ˆæ™‚å™¨
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
            if (shareIntervalId) {
                clearInterval(shareIntervalId);
                shareIntervalId = null;
            }
            
            // ä½¿ç”¨ pauseVideo() ä»£æ›¿ stopVideo()
            activePlayer.pauseVideo(); 
            
            // åœ¨ç·¨è¼¯æ¨¡å¼ä¸‹ï¼Œé‡æ–°å•Ÿç”¨æŒ‰éˆ•
            if (activePlayer === player) {
                document.getElementById('play-full-spliced-btn').disabled = false;
                document.getElementById('play-full-spliced-btn').textContent = `é è¦½å®Œæ•´å‰ªæ¥å½±ç‰‡ (${segments.length} ç‰‡æ®µ)`;
            }
        }

        // --- æ­¥é©Ÿ 2: ç‰‡æ®µç·¨è¼¯ ---

        /** å‹•æ…‹æ–°å¢ä¸€å€‹ç‰‡æ®µè¼¸å…¥å€ */
        function addSegment() {
            const newIndex = segments.length;
            // é è¨­ä¸€å€‹ç©ºç‰‡æ®µ
            segments.push({ start: 0, end: 0, startInput: '', endInput: '' });
            renderSegmentsList();
        }

        /** ç§»é™¤æŒ‡å®šç´¢å¼•çš„ç‰‡æ®µ */
        function removeSegment(index) {
            segments.splice(index, 1);
            renderSegmentsList();
            updateShareLink();
        }

        /** æ“·å–ç•¶å‰æ’­æ”¾å™¨çš„æ™‚é–“åˆ°æŒ‡å®šè¼¸å…¥æ¬„ä½ */
        function captureTime(index, type) {
            if (!player || player.getPlayerState() === -1) {
                displayMessage('è«‹å…ˆè¼‰å…¥å½±ç‰‡ï¼', 'warning');
                return;
            }

            const currentTime = player.getCurrentTime();
            const timeStr = secondsToTime(currentTime);

            // æ›´æ–° segments é™£åˆ—å’Œ input æ¬„ä½
            if (type === 'start') {
                segments[index].start = currentTime;
                segments[index].startInput = timeStr;
                document.getElementById(`start-input-${index}`).value = timeStr;
            } else if (type === 'end') {
                segments[index].end = currentTime;
                segments[index].endInput = timeStr;
                document.getElementById(`end-input-${index}`).value = timeStr;
            }

            // æ›´æ–°åˆ†äº«é€£çµ
            updateShareLink();
            // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°é è¦½æŒ‰éˆ•ç‹€æ…‹
            renderSegmentsList();
        }

        /** å¾è¼¸å…¥æ¬„ä½æ›´æ–° segments é™£åˆ— */
        function updateSegmentFromInput(index, type, value) {
            const seconds = timeToSeconds(value);

            if (type === 'start') {
                segments[index].start = seconds;
                segments[index].startInput = value;
            } else if (type === 'end') {
                segments[index].end = seconds;
                segments[index].endInput = value;
            }

            // æ›´æ–°åˆ†äº«é€£çµ
            updateShareLink();
            // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°é è¦½æŒ‰éˆ•ç‹€æ…‹
            renderSegmentsList();
        }

        /** æ¸²æŸ“ç‰‡æ®µåˆ—è¡¨çš„ HTML çµæ§‹ */
        function renderSegmentsList() {
            const list = document.getElementById('segments-list');
            list.innerHTML = ''; // æ¸…ç©ºç¾æœ‰åˆ—è¡¨

            segments.forEach((segment, index) => {
                const isComplete = segment.start >= 0 && segment.end > segment.start;
                const segmentElement = document.createElement('div');
                segmentElement.className = `p-4 border rounded-lg shadow-sm space-y-3 transition duration-200 ${isComplete ? 'border-green-300 bg-green-50' : 'border-gray-300 bg-white'}`;
                segmentElement.innerHTML = `
                    <div class="flex justify-between items-center pb-2 border-b">
                        <h4 class="text-base font-semibold text-gray-700">ç‰‡æ®µ #${index + 1}</h4>
                        <button onclick="removeSegment(${index})" class="text-red-500 hover:text-red-700 transition duration-150">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- é–‹å§‹æ™‚é–“ -->
                        <div class="flex items-center space-x-2">
                            <input type="text" id="start-input-${index}" placeholder="é–‹å§‹ (MM:SS)" value="${segment.startInput}"
                                onchange="updateSegmentFromInput(${index}, 'start', this.value)"
                                class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <button onclick="captureTime(${index}, 'start')"
                                    class="flex-shrink-0 px-3 py-2 text-xs bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-150 whitespace-nowrap">
                                æ“·å–ç•¶å‰æ™‚é–“
                            </button>
                        </div>
                        <!-- çµæŸæ™‚é–“ -->
                        <div class="flex items-center space-x-2">
                            <input type="text" id="end-input-${index}" placeholder="çµæŸ (MM:SS)" value="${segment.endInput}"
                                onchange="updateSegmentFromInput(${index}, 'end', this.value)"
                                class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <button onclick="captureTime(${index}, 'end')"
                                    class="flex-shrink-0 px-3 py-2 text-xs bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-150 whitespace-nowrap">
                                æ“·å–ç•¶å‰æ™‚é–“
                            </button>
                        </div>
                    </div>

                    <!-- é è¦½æŒ‰éˆ• -->
                    <button onclick="previewSegment(${index})" ${isComplete ? '' : 'disabled'}
                            class="w-full mt-2 px-4 py-2 bg-yellow-500 text-white font-medium rounded-lg hover:bg-yellow-600 transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                        é è¦½ç‰‡æ®µ #${index + 1} (${segment.startInput} ~ ${segment.endInput})
                    </button>
                `;
                list.appendChild(segmentElement);
            });

            // æ›´æ–°ä¸»è¦æ’­æ”¾æŒ‰éˆ•çš„ç‹€æ…‹
            checkFullSplicedPlayability();
        }

        /** æª¢æŸ¥æ˜¯å¦æ‰€æœ‰ç‰‡æ®µéƒ½æœ‰æ•ˆï¼Œä¸¦æ›´æ–°ä¸»è¦æ’­æ”¾æŒ‰éˆ• */
        function checkFullSplicedPlayability() {
            const allValid = segments.length > 0 && segments.every(s => s.start >= 0 && s.end > s.start);
            const button = document.getElementById('play-full-spliced-btn');
            button.disabled = !allValid;
            button.textContent = `é è¦½å®Œæ•´å‰ªæ¥å½±ç‰‡ (${segments.length} ç‰‡æ®µ)`;

            const shareLinkArea = document.getElementById('share-link-area');
            if (allValid) {
                shareLinkArea.classList.remove('hidden');
            } else {
                shareLinkArea.classList.add('hidden');
            }
        }

        /** é è¦½å–®å€‹ç‰‡æ®µ */
        function previewSegment(index) {
            if (!player) {
                displayMessage('è«‹å…ˆè¼‰å…¥å½±ç‰‡ï¼', 'warning');
                return;
            }

            const segment = segments[index];
            if (segment.start >= segment.end) {
                displayMessage('é–‹å§‹æ™‚é–“å¿…é ˆæ—©æ–¼çµæŸæ™‚é–“ã€‚', 'warning');
                return;
            }

            // 1. åœæ­¢ä»»ä½•æ­£åœ¨é€²è¡Œçš„æ’­æ”¾åºåˆ—ï¼Œç¢ºä¿ç‹€æ…‹é‡ç½®
            stopSequencePlayback(player);

            // 2. è¨­å®šç‹€æ…‹ï¼šå°‡ç•¶å‰ç‰‡æ®µè¨­ç‚ºè¦é è¦½çš„ç‰‡æ®µï¼Œä¸¦é–‹å•Ÿåºåˆ—æ’­æ”¾æ¨¡å¼
            isPlayingSequence = true;
            currentSegmentIndex = index;

            // 3. å»¶é² 50 æ¯«ç§’å¾ŒåŸ·è¡Œ Seek å’Œ Play
            setTimeout(() => {
                player.seekTo(segment.start, true);
                player.playVideo();
            }, 50);


            displayMessage(`æ­£åœ¨é è¦½ç‰‡æ®µ #${index + 1} (${segment.startInput} ~ ${segment.endInput})`, 'info');
        }

        /** æ’­æ”¾å®Œæ•´å‰ªæ¥å½±ç‰‡åºåˆ— */
        function playFullSplicedVideo(useSharePlayer = false) {
            const activePlayer = useSharePlayer ? sharePlayer : player;
            if (!activePlayer) {
                displayMessage('æ’­æ”¾å™¨æœªæº–å‚™å¥½ã€‚', 'warning');
                return;
            }

            if (segments.length === 0 || !segments.every(s => s.start >= 0 && s.end > s.start)) {
                displayMessage('è«‹å…ˆè¨­å®šæœ‰æ•ˆçš„å‰ªè¼¯ç‰‡æ®µã€‚', 'error');
                return;
            }

            if (!useSharePlayer) {
                // ç·¨è¼¯æ¨¡å¼ä¸‹ï¼Œç¦ç”¨æŒ‰éˆ•ä¸¦é¡¯ç¤ºç‹€æ…‹
                document.getElementById('play-full-spliced-btn').disabled = true;
                document.getElementById('play-full-spliced-btn').textContent = 'â–¶ï¸ æ­£åœ¨æ’­æ”¾...';
            }

            // åˆå§‹åŒ–åºåˆ—æ’­æ”¾ç‹€æ…‹
            isPlayingSequence = true;
            currentSegmentIndex = 0;

            const firstSegment = segments[0];
            activePlayer.seekTo(firstSegment.start, true);
            activePlayer.playVideo();

            displayMessage(`é–‹å§‹æ’­æ”¾å®Œæ•´å‰ªæ¥åºåˆ— (å…± ${segments.length} å€‹ç‰‡æ®µ)...`, 'info');
        }


        // --- åˆ†äº«/URL è™•ç† ---

        /** ç”¢ç”Ÿåˆ†äº«é€£çµä¸¦æ›´æ–°è¼¸å…¥æ¡† */
        function updateShareLink() {
            if (!videoId || segments.length === 0 || !segments.every(s => s.start >= 0 && s.end > s.start)) {
                document.getElementById('share-link').value = 'è«‹å®Œæˆæ‰€æœ‰æœ‰æ•ˆçš„å‰ªè¼¯ç‰‡æ®µä»¥ç”Ÿæˆåˆ†äº«é€£çµ';
                return;
            }

            // ç°¡åŒ– segments æ•¸æ“šç‚º S-E,S-E,... æ ¼å¼
            const data = segments
                .filter(s => s.start < s.end) // ç¢ºä¿åªåŒ…å«æœ‰æ•ˆç‰‡æ®µ
                .map(s => `${Math.floor(s.start)}-${Math.ceil(s.end)}`) // ä½¿ç”¨æ•´æ•¸ç§’æ•¸
                .join(',');

            const shareUrl = `${window.location.origin}${window.location.pathname}?v=${videoId}&segments=${encodeURIComponent(data)}`;
            document.getElementById('share-link').value = shareUrl;
        }

        /** è¤‡è£½åˆ†äº«é€£çµ */
        function copyShareLink() {
            const linkInput = document.getElementById('share-link');
            try {
                // è¼ƒèˆŠçš„ execCommand ä»ç„¶æ˜¯ iFrame å…§æœ€å¯é çš„æ–¹æ³•
                linkInput.select();
                document.execCommand('copy');
                displayMessage('åˆ†äº«é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 'success');
            } catch (err) {
                displayMessage('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½é€£çµã€‚', 'error');
            }
        }

        /** å¾ URL åƒæ•¸è§£æå½±ç‰‡ ID å’Œç‰‡æ®µæ•¸æ“š */
        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const vParam = params.get('v');
            const segmentsParam = params.get('segments');

            if (vParam && segmentsParam) {
                isShareMode = true;
                videoId = vParam;

                // è§£æç‰‡æ®µæ•¸æ“š
                const parsedSegments = segmentsParam.split(',')
                    .map(pair => {
                        const [start, end] = pair.split('-').map(Number);
                        if (end > start) {
                            return {
                                start: start,
                                end: end,
                                startInput: secondsToTime(start),
                                endInput: secondsToTime(end)
                            };
                        }
                        return null;
                    })
                    .filter(s => s !== null);

                if (parsedSegments.length > 0) {
                    segments = parsedSegments;
                    switchToShareView();
                } else {
                    // æ•¸æ“šç„¡æ•ˆï¼Œåˆ‡æ›å›ç·¨è¼¯æ¨¡å¼
                    isShareMode = false;
                    displayMessage('URLä¸­çš„å‰ªè¼¯æ•¸æ“šç„¡æ•ˆï¼Œå·²åˆ‡æ›å›ç·¨è¼¯æ¨¡å¼ã€‚', 'warning');
                }
            }
        }

        /** åˆ‡æ›åˆ°åˆ†äº«æ¨¡å¼ä»‹é¢ */
        function switchToShareView() {
            document.getElementById('editor-view').classList.add('hidden');
            document.getElementById('share-view').classList.remove('hidden');

            document.getElementById('share-info').innerHTML = `å½±ç‰‡ ID: <span class="font-bold text-gray-800">${videoId}</span>ï¼Œå…± <span class="font-bold text-gray-800">${segments.length}</span> å€‹ç‰‡æ®µã€‚`;

            // åˆå§‹åŒ–åˆ†äº«æ’­æ”¾å™¨
            initYouTubePlayer('share-player', videoId, false);
            displayMessage('é€²å…¥åˆ†äº«æ¨¡å¼ï¼Œæ’­æ”¾å™¨å°‡è‡ªå‹•è¼‰å…¥ä¸¦é–‹å§‹æ’­æ”¾ã€‚', 'info');
        }

        // --- åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼ ---

        window.onload = function () {
            checkUrlParams();
            // å¦‚æœä¸æ˜¯åˆ†äº«æ¨¡å¼ï¼Œå‰‡æ‰‹å‹•è§¸ç™¼ä¸€æ¬¡æ¸²æŸ“ï¼Œç¢ºä¿ç·¨è¼¯ä»‹é¢æ­£ç¢º
            if (!isShareMode) {
                 // è¼‰å…¥æ™‚é è¨­è¼‰å…¥ä¸€å€‹ç‰‡æ®µï¼Œæ–¹ä¾¿ä½¿ç”¨è€…é–‹å§‹
                addSegment();
            }
        };

        // ç›£è½ YouTube Player API è¼‰å…¥å®Œæˆ
        function onYouTubeIframeAPIReady() {
            // å¦‚æœä¸æ˜¯åˆ†äº«æ¨¡å¼ï¼Œé è¼‰å…¥ä¸€å€‹ç¯„ä¾‹ IDï¼Œæ–¹ä¾¿æ¸¬è©¦
            if (!isShareMode) {
                const exampleId = '2n7r6jN_q3M'; 
                document.getElementById('youtube-url').value = `https://www.youtube.com/watch?v=${exampleId}`;
            }
        }

    </script>
</body>
</html>
